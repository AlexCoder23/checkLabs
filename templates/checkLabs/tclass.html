<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link href="/static/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <script src="/static/bootstrap.bundle.min.js"crossorigin="anonymous"></script>

  <link rel="stylesheet" href="https://cdn.datatables.net/2.1.8/css/dataTables.dataTables.css">

  <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.0/socket.io.js"></script>
  
  <script src="https://cdn.datatables.net/2.1.8/js/dataTables.js"></script>
  
  <script src="/static/cookie.js"></script>
  
  <script type="application/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.4.0/min/dropzone.min.js"></script>

  <link rel="stylesheet" href="/static/codemirror/lib/codemirror.css"/>
  <link rel="stylesheet" href="/static/codemirror/theme/night.css"/>
  <link rel="stylesheet" href="/static/codemirror/theme/lesser-dark.css"/>
  <script src="/static/codemirror/lib/codemirror.js"></script>
  <script src="/static/codemirror/mode/python/python.js"></script>
  <script src="/static/codemirror/mode/javascript/javascript.js"></script>
  <script src="/static/codemirror/mode/css/css.js"></script>
  <script src="/static/codemirror/mode/xml/xml.js"></script>
  <script src="/static/codemirror/mode/htmlmixed/htmlmixed.js"></script>
  <script src="/static/codemirror/addon/edit/matchbrackets.js"></script>
  <script src="/static/codemirror/addon/edit/closebrackets.js"></script>
  <script src="/static/codemirror/addon/selection/active-line.js"></script>
  <script src="/static/codemirror/addon/comment/comment.js"></script>

  <link rel="stylesheet" href="/static/codemirror/addon/hint/show-hint.css">
  <script src="/static/codemirror/addon/hint/show-hint.js"></script>
  <script src="/static/codemirror/addon/hint/anyword-hint.js"></script>
  <script src="/static/codemirror/addon/hint/css-hint.js"></script>
  <script src="/static/codemirror/addon/hint/javascript-hint.js"></script>
  <script src="/static/codemirror/addon/hint/xml-hint.js"></script>
  <script src="/static/codemirror/addon/hint/html-hint.js"></script>
  <script src="/static/codemirror/addon/hint/sql-hint.js"></script>
    
  <title>Учитель</title>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      z-index: 1;
    }
    body {
      height: 100vh;
      width: 100vw;
      display: flex;
      flex-direction: column;
      margin: 0;
      padding: 6px;
      font-family: 'IBM Plex Sans', sans-serif;
    }
    body > *::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    body > *::-webkit-scrollbar-track {
/*       background: rgb(14, 21, 37); */
      height: 6px;
      width: 6px;
    }
    body > *::-webkit-scrollbar-thumb {
      background-color: gray;
      border-radius: 6px;
      width: 6px;
      height: 6px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header > div {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    input[type=range][orient=vertical] {
        writing-mode: vertical-lr;
        direction: rtl;
        appearance: slider-vertical;
        width: 16px;
        vertical-align: bottom;
    }

    #serv-btn > img {
      height: 38pt;
    }

    main {
      width: 100%;
      flex: 1 1 auto;
      display: flex;
    }

    p {
      margin: 0 2px;
    }
    
    .toolh {
      padding-left: 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      white-space: nowrap;
      overflow: hidden;
    }
    .toolh > *:first-child {
      flex-grow: 1;
    }
    .toolh > *:last-child {
      margin-left: 4px;
    }
    .toolh::before {
      content: ">";
      z-index: 0;
      position: absolute;
      transform: translateX(-14px);
      transition: transform 0.3s;
    }
    .toolh[opened="1"]::before  {
      transform: translateX(-14px) rotate(90deg);
    }
    
    .toolb {
      padding-left: 14px;
      white-space: nowrap;
      overflow: hidden;
    }
    
    .in-row {
      display: flex;
      column-gap: 10px;
    }
    
    #sidebar {
      height: 100%;
    }

    .mcont {
      height: 100%;
      width: 100%;
    }

    .tabs {
      display: flex;
      position: absolute;
      overflow-x: auto;
      height: 30px;
    }
    .tabs::-webkit-scrollbar {
      height: 7px;
    }
    .tabs::-webkit-scrollbar-track {
    }
    .tabs::-webkit-scrollbar-thumb {
      background-color: gray;
      border-radius: 8px;
    }

    .tab {
      display: flex;
      padding: 2px;
      border-right: 1px solid rgb(90 90 90);
      cursor: pointer;
    }
    .tab > * {
      margin: 1px;
      white-space: nowrap;
    }

    .mdiv {
      width: 100%;
      height: 100%;
      padding-top: 30px;
    }
    
    #resizer {
      width: 7px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: col-resize;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      background-color: white;
    }
    #resizer > div {
      width: 3px;
      height: 24px;
      background-color: rgb(28, 35, 51);
    }
    #resizer:hover > div {
      background-color: white;
    }

    #sidebar-right {
      height: 100%;
      background-color: white;
    }

    #tools {
      height: 100%;
      overflow-y: auto;
      cursor: default;
    }
    #tools::-webkit-scrollbar {
      width: 6px;
    }
    #tools::-webkit-scrollbar-track {
/*       background: rgb(14, 21, 37); */
      width: 6px;
      height: 6px;
    }
    #tools::-webkit-scrollbar-thumb {
      background-color: gray;
      border-radius: 6px;
      width: 6px;
      height: 6px;
    }
    
    .toolb {
      max-height: 260px;
      overflow-y: auto;
    }
    
    #inv-token {
      width: 98%;
    }
    
    #stud-list {
      display: flex;
      flex-direction: column;
      padding-left: 5px;
    }
    
    #task-list {
      display: flex;
      flex-direction: column;
      padding-left: 10px;
    }
    
    .token {
      cursor: pointer;
    }
    .token:hover::after {
      content: 'Скопировать';
      position: absolute;
      translate: position(3px, -3px);
      z-index: 10;
      background: rgba(255,255,230,0.9);
      font-family: Arial, sans-serif;
      font-size: 11px;
      padding: 5px 10px;
      border: 1px solid #333;
    }
    
    #add-task-form {
      display: flex;
      gap: 10px;
    }
    
    #add-task-form > input {
      flex-grow: 7.22;
    }
    
    #add-task-form > button {
      flex-grow: 2.78;
    }
    
    #task-form-edit > *:nth-child(1) { grid-area: b; }
    #task-form-edit > *:nth-child(2) { grid-area: c; }
    #task-form-edit > *:nth-child(3) { grid-area: d; }
    #task-form-edit > *:nth-child(4) { grid-area: e; }
    #task-form-edit > *:nth-child(5) { grid-area: a; }

    #task-form-edit > * {
      min-width: 0;
      padding: 3px;
    }

    #task-form-edit {
      display: grid;
      width: 100%;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      grid-template-areas: "b c" "d e" "a a";
      gap: 10px;
    }
    
    .actions {
      position: absolute;
      background-color: white;
      border-radius: 8px;
      overflow: hidden;
      width: 170px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      z-index: 3;
      box-shadow: 5px 5px 20px 1px rgb(10 133 100);
    }
    .actions > p {
      padding: 4px 6px;
      margin-bottom: 0px;
      border-bottom: 1px solid rgb(10 133 100);
    }
    .actionss > * {
      width: 100%;
    }
    .actions > div > * {
      display: block;
      width: 100%;
      padding: 4px 6px;
    }
    .actions > div  >*:hover {
      background-color: rgba(10 133 100 / 10%);
      cursor: pointer;
    }
    
    .invite {
      white-space: nowrap;
      border-radius: 4px;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      cursor: pointer;
    }
    .invite:hover {
      background-color: rgba(10 133 100 / 10%);
    }
    
    .student {
      display: flex;
      align-items: center;
      justify-content: space-between;
      white-space: nowrap;
      border-radius: 4px;
      font-size: 14px;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      height: 1.6em;
      cursor: pointer;
    }
    .student:hover {
      background-color: rgba(10 133 100 / 10%);
    }
    .student > a {
      padding: 2px 4px;
      height: 100%;
      padding: 2px 4px;
      white-space: nowrap;
      overflow: hidden;
      margin: 0;
    }
    .student > span {
      height: 100%;
    }
    .student > span > img, .student > span > svg {
      height: 100%;
      aspect-ratio: 1/1;
      padding: 3px;
      border-radius: 4px;
    }
    .student > span > img:hover, .student > span > svg:hover {
      background-color: rgba(10 133 100 / 10%);
    }
    
    .task {
      display: flex;
      align-items: center;
      justify-content: space-between;
      white-space: nowrap;
      border-radius: 4px;
      font-size: 14px;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      height: 1.6em;
      cursor: pointer;
    }
    .task > a {
      padding: 0px 2px;
      height: 100%;
      padding: 2px 4px;
      white-space: nowrap;
      overflow: hidden;
      margin: 0;
    }
    .task > a:hover {
      background-color: rgba(10 133 100 / 10%);
    }
    .task > p {
      padding: 2px 4px;
      white-space: nowrap;
      overflow: hidden;
      margin: 0;
    }
    
    .file {
      display: flex;
      align-items: center;
      justify-content: space-between;
      white-space: nowrap;
      border-radius: 4px;
      font-size: 13px;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      margin-left: 10px;
      cursor: pointer;
    }
    .file:hover {
      background-color: rgba(10 133 100 / 10%);
    }
    .file > a {
      padding: 2px 4px;
      height: 100%;
    }
    .file > a:hover {
      background-color: rgba(10 133 100 / 10%);
    }
    .file > p {
      padding: 2px 4px;
      white-space: nowrap;
      overflow: hidden;
      margin: 0;
    }
    
    .coAreaBlock {
      display: flex;
      flex-direction: column;
      border-radius: 6px;
      overflow: hiden;
      font-family: 'ReplitHack', monospace;
      padding: 2px;
    }
    .coAreaBlock-header {
      display: flex;
      justify-content: space-between;
    }
    .coAreaBlock-header > * {
      margin: 2px;
    }
    .coAreaBlock-body {
      display: flex;
      flex-direction: row;
      flex-grow: 1;
      width: 100%;
    }
   
    .dz-clickable {
      padding: 2px 4px;
      white-space: nowrap;
      overflow: hidden;
      margin: 0;
    }
    
    #mark-inp {
      flex-grow: 5;
    }

    #mark-btn {
      flex-grow: 2;
    }

    .mark-description {
      margin-top: 10px;
      width: 100%;
      height: 170px;
    }

  </style>
</head>
  <body>
    
    <div class="modal fade" id="add-task-modal" tabindex="-1" aria-labelledby="add-task" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" style="color: black;">Добавить задание</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
          </div>
          <div class="modal-body" id="add-task-form">
            <input type="text" autocomplete="off" maxlength=64 placeholder="Название задания" id="new-task-name">
            <button id="add-task-btn">Добавить</button>
          </div>
        </div>
      </div>
    </div>
    
    <div class="modal fade" id="task-modal" tabindex="-1" aria-labelledby="task" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" style="color: black;">Настройки задания</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
          </div>
          <div class="modal-body" id="task-form-edit">
            <input type="text" autocomplete="off" maxlength=64 placeholder="Название" id="name-task-edit">
            <button id="save-ed-task-btn" class="btn btn-primary">Сохранить</button>
            <input type="number" autocomplete="off" maxlength=64 placeholder="Таймер доступа(выключен если поле пустое)" id="time-task-edit">
            <button id="edit-access" class="btn btn-primary">Открыть доступ</button>
            <button id="delete-task-btn" class="btn btn-danger">Удалить</button>
          </div>
        </div>
      </div>
    </div>
    
    <div class="modal fade" id="remove-stud-modal" tabindex="-1" aria-labelledby="add-task" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" style="color: black;">Удалить?</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
          </div>
          <div class="modal-body" id="add-task-form">
            <p>Удалить ученика <span id="rem-name-stud"></span> из класса?</p>
            <button id="remove-stud-modal-btn"class="btn btn-danger">Удалить</button>
          </div>
        </div>
      </div>
    </div>
    
    <div class="modal fade" id="mark-modal" tabindex="-1" aria-labelledby="add-mark" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" style="color: black;">Оценить</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
          </div>
          <div class="modal-body">
            <div class="in-row">
              <input type="number" maxlength=64 placeholder="Оценка" id="mark-inp"><br/>
              <button id="mark-btn">Оценить</button>
            </div>
            <textarea maxlength=256 placeholder="Коментарий" id="mark-description"></textarea><br/>
          </div>
        </div>
      </div>
    </div>
    
    <div class="modal fade" id="mark-neiro-modal" tabindex="-1" aria-labelledby="add-mark" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" style="color: black;">Нейропомощь</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
          </div>
          <div class="modal-body">
            <div class="in-row">
              <input type="number" maxlength=64 placeholder="Оценка" id="mark-inp3"><br/>
              <button id="mark-btn">Оценить</button>
            </div>
            <textarea placeholder="Коментарий" id="mark-description1" class="mark-description"></textarea><br/>
            <textarea placeholder="Вердикт" id="teach-verd" class="mark-description"></textarea><br/>
          </div>
        </div>
      </div>
    </div>
    
    <main>
      <div id="sidebar">
        <div id="tools">
          <p style="margin: 0;">Идентификатор класса: <span id="header-class-id">#00000</span></p>
          <div class="toolh" target="#toolh-sts" opened="1">
            <p id="toolh-sts" target="#toolb-sts">Ученики</p>
            <a></a>
          </div>
          <div class="toolb" id="toolb-sts">
            <div id="stud-list">
            </div>
            <i id="no-students">Учеников нет</i>
            <div class="toolh" target="#toolh-invs" opened="0">
              <p id="toolh-invs" target="#toolb-invs">Заявки</p>
              <a> </a>
            </div>
            <div class="toolb" id="toolb-invs" style="overflow: hidden;">
              <div id="appl-list">
              </div>
              <i id="no-applications">Заявок нет</i>
            </div>
          </div>

          <div class="toolh" target="#toolh-tss" opened="1">
            <p id="toolh-tss" target="#toolb-tss">Задания</p>
            <a data-bs-toggle="modal" data-bs-target="#add-task-modal">+</a>
          </div>
          <div class="toolb" id="toolb-tss">
            <div id="task-list">
            </div>
            <i id="no-tasks">Заданий нет</i>
          </div>
        </div>
      </div>
      <div id="resizer"><div></div></div>
      <div id="sidebar-right">
        <div class="mcont">
          <div id="tabs" class="tabs">
          </div>
          <div id="mdiv" class="mdiv">
          </div>
        </div>
      </div>
    </main>
    
    <div id="messs">
    </div>
    
    <div id="file-actions-cont" class="actions">
      <p>Действия</p>
      <div>
        <a id="act-file-rname-btn">Переименовать</a>
        <a id="act-file-download-btn">Скачать</a>
        <a id="delete-file-btn">Удалить</a>
      </div>
    </div>
    
    <div id="task-actions-cont" class="actions">
      <p>Действия</p>
      <div>
        <a id="act-task-mark-btn">Оценить</a>
        <a id="act-task-neiro-btn">Нейропомощь</a>
      </div>
    </div>
    
    <template id="coAreaBlock-template">
      <div class="coAreaBlock">
        <div class="coAreaBlock-header">
          <p class="coAreaBlock-fname">test.py</p>
          <select class="coAreaBlock-select">
          	<option>python</option>
          	<option>htmlmixed</option>
          	<option>css</option>
          	<option>javascript</option>
          </select>
        </div>
        <hr style="width: 100%; margin: 0;">
        <div class="coAreaBlock-body">
          
        </div>
        <hr style="width: 100%; margin: 0; margin-top: 1.9px;">
        <div class="coAreaBlock-footer">
        </div>
      </div>
    </template>
    
  </body>
  
  <script>
    
function preventDefaults (e) {
  e.preventDefault();
  e.stopPropagation();
}

const pythonIcon = '<svg width="16" height="16" viewBox="0 0 24 24"><path fill="#0093B0" d="M9.804 12.041h4.962c1.382 0 2.485-1.137 2.485-2.525v-4.73c0-1.347-1.136-2.359-2.485-2.583A15.437 15.437 0 0 0 12.178 2c-.849.005-1.66.076-2.374.203-2.103.37-2.485 1.149-2.485 2.582V6.68h4.968v.631H5.454c-1.444 0-2.708.868-3.104 2.52-.456 1.892-.477 3.073 0 5.05.353 1.47 1.196 2.519 2.64 2.519H6.7v-2.27c0-1.64 1.419-3.087 3.104-3.087ZM9.49 5.417a.938.938 0 0 1-.932-.944c0-.524.416-.95.932-.95.513 0 .933.426.933.95a.938.938 0 0 1-.933.944Zm12.728 4.412c-.356-1.438-1.038-2.52-2.484-2.52h-1.865v2.206c0 1.71-1.45 3.151-3.104 3.151H9.804c-1.36 0-2.485 1.164-2.485 2.525v4.731c0 1.347 1.17 2.138 2.485 2.525 1.573.463 3.08.546 4.962 0 1.251-.362 2.485-1.091 2.485-2.525v-1.894h-4.963v-.63h7.448c1.444 0 1.981-1.008 2.484-2.52.519-1.557.497-3.053 0-5.05Zm-7.14 9.463c.516 0 .933.422.933.943 0 .524-.417.95-.932.95a.943.943 0 0 1-.933-.95c0-.522.419-.943.933-.943Z"></path></svg>'

const cssIcon = '<svg width="16" height="16" viewBox="0 0 24 24"><path fill="#0079F2" d="m3 2 1.638 18.373 7.35 2.04 7.372-2.043L21 2H3Zm14.596 4.202-.553 6.21-.384 4.284-.034.381-4.622 1.282-4.615-1.282-.316-3.539h2.262l.16 1.798 2.512.677.007-.002h.001l2.506-.676.263-2.922h-5.26l-.045-.506-.103-1.143-.053-.604h5.66l.207-2.308H6.566l-.045-.507-.103-1.142-.054-.604h11.288l-.055.604Z"></path></svg>'

const htmlIcon = '<svg width="16" height="16" viewBox="0 0 24 24"><path fill="#AD5700" d="M3 2 4.64 20.4l7.35 2.045 7.371-2.047L21 2H3Zm3.404 4.367L6.35 5.76h5.643v2.256h-3.18l.205 2.312h2.974v2.256H6.959l-.554-6.219Zm10.772 4.568-.53 5.942-.034.38-4.623 1.284-4.616-1.283-.316-3.544H9.32l.16 1.8 2.512.678 2.513-.68.261-2.926h-2.767v-2.257h5.23l-.055.606h.003Zm.408-4.568L17.48 7.51l-.045.507H12V5.762h5.638l-.054.605Z"></path></svg>'

const jsIcon = '<svg width="16" height="16" viewBox="0 0 24 24"><path fill="#967D00" d="M4.271 2A2.271 2.271 0 0 0 2 4.271V19.73A2.271 2.271 0 0 0 4.271 22H19.73A2.272 2.272 0 0 0 22 19.729V4.27A2.271 2.271 0 0 0 19.729 2H4.27Zm8.167 17.109c-.294.599-.857.992-1.51 1.182-1.001.23-1.96.1-2.672-.329-.478-.293-.85-.743-1.103-1.262.508-.31 1.014-.622 1.521-.932.014.006.053.078.107.171.194.326.361.556.69.717.324.11 1.032.18 1.306-.388.168-.289.114-1.237.114-2.266 0-1.616.008-3.205.008-4.841h1.87c0 1.718.01 3.44 0 5.155.004 1.052.096 2.008-.33 2.793Zm7.761-.529c-.65 2.225-4.276 2.297-5.724.827-.306-.345-.498-.526-.68-.926.77-.443.77-.443 1.518-.876.408.626.784.97 1.46 1.11.92.112 1.843-.203 1.636-1.178-.213-.797-1.88-.99-3.015-1.843-1.152-.774-1.422-2.654-.475-3.728.315-.397.853-.694 1.418-.836.195-.025.393-.052.589-.076 1.131-.024 1.838.275 2.357.855.145.147.262.304.483.647-.602.384-.6.38-1.464.94a1.392 1.392 0 0 0-.813-.755c-.502-.152-1.135.013-1.266.543-.046.164-.036.316.036.586.204.464.886.665 1.498.946 1.763.715 2.358 1.481 2.504 2.394.14.785-.034 1.294-.06 1.37h-.002Z"></path></svg>'

const imgIcon = '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M5 3.75c-.69 0-1.25.56-1.25 1.25v14c0 .594.415 1.092.97 1.219l10.75-10.75a.75.75 0 0 1 1.06 0l3.72 3.72V5c0-.69-.56-1.25-1.25-1.25H5ZM21.75 5A2.75 2.75 0 0 0 19 2.25H5A2.75 2.75 0 0 0 2.25 5v14A2.75 2.75 0 0 0 5 21.75h14A2.75 2.75 0 0 0 21.75 19V5Zm-1.5 10.31L16 11.06l-9.19 9.19H19c.69 0 1.25-.56 1.25-1.25v-3.69ZM8.5 7.75a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5Zm-2.25.75a2.25 2.25 0 1 1 4.5 0 2.25 2.25 0 0 1-4.5 0Z" clip-rule="evenodd"></path></svg>'

const jsonIcon = '<svg width="16" height="16" viewBox="0 0 24 24"><path fill="#967D00" d="M18.588 11.13c0-3.155-.965-5.307-2.216-6.728C18.94 5.934 21 8.685 21 12.483c0 5.484-4.624 9.505-9.48 9.505-.272 0-1.796-.159-3.239-1.243-1.411-1.06-2.808-3.056-2.808-6.854 0-3.877 2.383-5.929 4.634-5.95-.146.121-.297.258-.448.414-.808.83-1.602 2.165-1.602 4.16 0 3.927 2.98 5.224 3.25 5.331 1.517.645 3.358.187 4.78-1.002 1.439-1.203 2.501-3.185 2.501-5.714Z"></path><path fill="#967D00" d="M11.48 3c.3 0 .626.03.97.09.139.034.289.077.45.132a6.36 6.36 0 0 1 2.038 1.17c1.37 1.163 2.65 3.22 2.65 6.738 0 2.238-.935 3.937-2.142 4.947-.835.698-1.777 1.052-2.634 1.06.16-.128.326-.276.493-.446.81-.828 1.607-2.16 1.607-4.155 0-4.036-3.147-5.294-3.266-5.338l-.007-.003.002-.005c-3.342-1.152-7.168 1.636-7.168 6.701 0 3.222.948 5.336 2.176 6.707C4.07 19.068 2 16.313 2 12.505 2 7.02 6.624 3 11.48 3Z"></path></svg>'

const audioIcon = '<svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentColor" d="M10.75 18.692q.815 0 1.379-.563q.563-.564.563-1.379v-3.98h1.962q.31 0 .54-.22q.23-.221.23-.55q0-.31-.23-.54q-.23-.23-.54-.23h-1.962q-.31 0-.54.23q-.229.23-.229.54v3.317q-.236-.257-.53-.383q-.293-.126-.643-.126q-.815 0-1.379.563q-.563.564-.563 1.379t.563 1.379q.564.563 1.379.563ZM6.615 21q-.69 0-1.152-.462Q5 20.075 5 19.385V4.615q0-.69.463-1.152Q5.925 3 6.615 3h7.214q.323 0 .628.13q.305.132.522.349L18.52 7.02q.217.217.348.522q.131.305.131.628v11.214q0 .69-.462 1.152q-.463.463-1.153.463H6.615ZM14 7.192V4H6.615q-.23 0-.423.192Q6 4.385 6 4.615v14.77q0 .23.192.423q.193.192.423.192h10.77q.23 0 .423-.192q.192-.193.192-.423V8h-3.192q-.348 0-.578-.23q-.23-.23-.23-.578ZM6 4v4v-4v16V4Z"/></svg>'

const videoIcon = '<svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentColor" d="M8.001 4h8v1.997h2V4A2 2 0 0 1 20 6v12a2 2 0 0 1-1.999 2v-2.003h-2V20h-8v-2.003h-2V20H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h.001v1.997h2V4zM10 15l4.5-3L10 9v6zm8.001.997v-3h-2v3h2zm0-5v-3h-2v3h2zm-10 5v-3h-2v3h2zm0-5v-3h-2v3h2z"/></svg>'

const zipIcon = '<svg width="16" height="16" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path d="M14 3v4a1 1 0 0 0 1 1h4"/><path d="M5 12V5a2 2 0 0 1 2-2h7l5 5v4m-3 6h1.5a1.5 1.5 0 0 0 0-3H16v6m-4-6v6m-7-6h3l-3 6h3"/></g></svg>'

const txtIcon = '<svg width="16" height="16" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path d="M14 3v4a1 1 0 0 0 1 1h4"/><path d="M14 3v4a1 1 0 0 0 1 1h4m-2.5 7h3"/><path d="M5 12V5a2 2 0 0 1 2-2h7l5 5v4M4.5 15h3M6 15v6m12-6v6m-8-6l4 6m-4 0l4-6"/></g></svg>'

const bashIcon = '<svg width="16" height="16" viewBox="0 0 128 128"><path fill="none" d="M-143.76 4.24h119.53v119.53h-119.53z"/><path fill="currentColor" d="M109.01 28.64L71.28 6.24c-2.25-1.33-4.77-2-7.28-2s-5.03.67-7.28 2.01l-37.74 22.4c-4.5 2.67-7.28 7.61-7.28 12.96v44.8c0 5.35 2.77 10.29 7.28 12.96l37.73 22.4c2.25 1.34 4.76 2 7.28 2c2.51 0 5.03-.67 7.28-2l37.74-22.4c4.5-2.67 7.28-7.62 7.28-12.96V41.6c0-5.34-2.77-10.29-7.28-12.96zM79.79 98.59l.06 3.22c0 .39-.25.83-.55.99l-1.91 1.1c-.3.15-.56-.03-.56-.42l-.03-3.17c-1.63.68-3.29.84-4.34.42c-.2-.08-.29-.37-.21-.71l.69-2.91c.06-.23.18-.46.34-.6c.06-.06.12-.1.18-.13c.11-.06.22-.07.31-.03c1.14.38 2.59.2 3.99-.5c1.78-.9 2.97-2.72 2.95-4.52c-.02-1.64-.9-2.31-3.05-2.33c-2.74.01-5.3-.53-5.34-4.57c-.03-3.32 1.69-6.78 4.43-8.96l-.03-3.25c0-.4.24-.84.55-1l1.85-1.18c.3-.15.56.04.56.43l.03 3.25c1.36-.54 2.54-.69 3.61-.44c.23.06.34.38.24.75l-.72 2.88c-.06.22-.18.44-.33.58a.77.77 0 0 1-.19.14c-.1.05-.19.06-.28.05c-.49-.11-1.65-.36-3.48.56c-1.92.97-2.59 2.64-2.58 3.88c.02 1.48.77 1.93 3.39 1.97c3.49.06 4.99 1.58 5.03 5.09c.05 3.44-1.79 7.15-4.61 9.41zm19.78-5.41c0 .3-.04.58-.29.72l-9.54 5.8c-.25.15-.45.02-.45-.28v-2.46c0-.3.18-.46.43-.61l9.4-5.62c.25-.15.45-.02.45.28v2.17zm6.56-55.09l-35.7 22.05c-4.45 2.6-7.73 5.52-7.74 10.89v43.99c0 3.21 1.3 5.29 3.29 5.9c-.65.11-1.32.19-1.98.19c-2.09 0-4.15-.57-5.96-1.64l-37.73-22.4c-3.69-2.19-5.98-6.28-5.98-10.67V41.6c0-4.39 2.29-8.48 5.98-10.67l37.74-22.4c1.81-1.07 3.87-1.64 5.96-1.64s4.15.57 5.96 1.64l37.74 22.4c3.11 1.85 5.21 5.04 5.8 8.63c-1.27-2.67-4.09-3.39-7.38-1.47z"/></svg>'

const otherIcon = '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M4.055 2.055A2.75 2.75 0 0 1 6 1.25h7a.75.75 0 0 1 .53.22l7 7c.141.14.22.331.22.53v11A2.75 2.75 0 0 1 18 22.75H6A2.75 2.75 0 0 1 3.25 20V4c0-.73.29-1.429.805-1.945ZM6 2.75A1.25 1.25 0 0 0 4.75 4v16A1.25 1.25 0 0 0 6 21.25h12A1.25 1.25 0 0 0 19.25 20V9.75H13a.75.75 0 0 1-.75-.75V2.75H6Zm7.75 1.06 4.44 4.44h-4.44V3.81Z" clip-rule="evenodd"></path></svg>'


$('#sidebar').width($('main').width() * ( 20 / 100 ));
$('#sidebar-right').width($('main').width() - $('#sidebar').width()-$('#resizer').width());
$('#slidbar-btn-child').width($('#sidebar').width()/$('main').width()*100+"%");
let clicked = false;
let prcl = [0, 0];
let opened_width = 0;
$('body').on("mousemove", function(e) {
  if(clicked) {
    let с = e.originalEvent.movementX
    $('#sidebar').width($('#sidebar').width() + с);
	$('#sidebar-right').width($('#sidebar-right').width() - с);
    $('#slidbar-btn-child').width($('#sidebar').width()/$('main').width()*100+"%");
  }
});
$('body').on("touchmove", function(e) {
  if(clicked) {
    $('#sidebar').css('width', $('#sidebar').width() + (e.touches[0].pageX - prcl[0]) + "px");
    prcl = [e.touches[0].pageX, e.touches[0].pageY];
  }
});
$('#resizer').on("mousedown touchstart", function(e) {
  $('body').css('cursor', 'col-resize');
  clicked = true;
  prcl = [e.touches[0].pageX, e.touches[0].pageY];
});
$('body').on("mouseup touchend", function(e) {
  if(clicked) { $('body').css('cursor', 'default'); }
clicked = false;
});
    

const Slid1ResizeObserver = new ResizeObserver(() => {
  $('#sidebar-right').width($('main').width() - $('#sidebar').width()-$('#resizer').width());
  $('#slidbar-btn-child').width($('#sidebar').width()/$('main').width()*100+"%");
});
Slid1ResizeObserver.observe($('main')[0]);

    
function init_audio() {
  if(qualize) return
  
  window.AudioContext = window.AudioContext || window.webkitAudioContext;

  var context = new AudioContext(),
    audio = document.getElementById('audio');

  var createFilter = function (frequency) {
    var filter = context.createBiquadFilter();

    filter.type = 'peaking'; // тип фильтра
    filter.frequency.value = frequency; // частота
    filter.Q.value = 1; // Q-factor
    filter.gain.value = 0;

    return filter;
  };

  var createFilters = function () {
    var frequencies = [60, 170, 310, 600, 1000, 3000, 6000, 12000, 14000, 16000],
      filters = frequencies.map(createFilter);

    filters.reduce(function (prev, curr) {
      prev.connect(curr);
      return curr;
    });

    return filters;
  };

  qualize = function (audio) {
    var source = context.createMediaElementSource(audio),
      filters = createFilters();

    // источник цепляем к первому фильтру 
    source.connect(filters[0]);
    // а последний фильтр - к выходу
    filters[filters.length - 1].connect(context.destination);
    return filters
  };
}
    
function save(name, area) {
  
}

function CodeArea(par) {
  let cont = document.querySelector("#coAreaBlock-template").content.cloneNode(true).querySelector(".coAreaBlock");
  par.append(cont);
  let area = CodeMirror(cont.querySelector(".coAreaBlock-body"), {
    mode:  "javascript",
    theme: "lesser-dark",
    lineWrapping: true,
    matchBrackets: true,
    styleActiveLine: true,
    lineNumbers: true,
    autoCloseTags: true,
    autoCloseBrackets: true
  });
  let pos = [0, 0];
  area.addKeyMap({
    "Ctrl-/": (instance) => { area.execCommand('toggleComment'); },
    "Ctrl-Space": "autocomplete",
    "Alt-R": (instance) => { pos[0] = area.getScrollInfo().left; pos[1] = area.getScrollInfo().top; },
    "Alt-Y": (instance) => { area.scrollTo(pos[0], pos[1]); }
  })
  area.setSize("100%", "100%");
  
  function upSize() {
  	$(cont.querySelector(".coAreaBlock-body")).height($(cont).height()-$(cont.querySelector(".coAreaBlock-footer")).height()-$(cont.querySelector(".coAreaBlock-header")).height()-4);
  }
  upSize();
  
  const resizeObserver = new ResizeObserver(() => {
  	upSize();
  });
  resizeObserver.observe(cont);
  resizeObserver.observe(cont.querySelector(".coAreaBlock-footer"));
  resizeObserver.observe(cont.querySelector(".coAreaBlock-header"));
  
  let name = cont.querySelector(".coAreaBlock-fname");
  const observer = new MutationObserver((mutationList, observer) => {
    let pref = name.textContent.split('.').at(-1);
  	if(pref == 'py') { 
   	  area.setOption("mode", "python");
   	} else if(pref == "js") {
      area.setOption("mode", "javascript");
    } else if(pref == "html") {
      area.setOption("mode", "htmlmixed");
    } else if(pref == "css") {
      area.setOption("mode", "css");
    } else {
      area.setOption("mode", "none");
    }
  });
  observer.observe(name, { childList: true, subtree: true });
  
  let me = {
    cont: cont,
    area: area
  };
  
  return me;
}
          

var files = document.querySelector("#files");
var nfile = "";
var open_tabs = {};
var renfile = NaN;
          
function gfile(task_id, name) {
  nfile = name;
  if(name in open_tabs) {
    open_tabs[name][0].fadeIn(0);
    for(let key in open_tabs) {
      if(key != name) { open_tabs[key][0].fadeOut(0); }
    }
  } else {
    open_tabs[name] = [];
    
    const tab = document.createElement("div");
    const tabt = document.createElement("p");
    $(tabt).text(name).click(function() {
      gfile(task_id, name);
    })
    tab.append(tabt);
    const tabc = document.createElement("p");
    tab.append(tabc);
    tab.classList.add('tab');
    $("#tabs").append(tab);
    
    if(name.endsWith('.jpg') || name.endsWith('.png')) {
      let img = document.createElement('img');
      
      $(img).attr('src', `/checkLabs/class/get_task_file/${class_id}/${task_id}/${name}`)
      if($(img).width()/$("#mdiv").width() > $(img).height()/$("#mdiv").height()) {
        $(img).css("width", "70%");
        $(img).css("height", "auto");
      } else {
        $(img).css("width", "auto");
        $(img).css("height", "70%");
      }
      let imgObserver = new ResizeObserver(() => {
        if($(img).width()/$("#mdiv").width() > $(img).height()/$("#mdiv").height()) {
          $(img).css("width", "70%");
          $(img).css("height", "auto");
        } else {
          $(img).css("width", "auto");
          $(img).css("height", "70%");
        }
      });
      imgObserver.observe($("#mdiv")[0]);
      $("#mdiv").append(img);
      for(let key in open_tabs) {
        if(key != name) { open_tabs[key][0].fadeOut(0); }
      }
      open_tabs[name] = [$(img), NaN];
    } else if(name.endsWith('.mp4')) {
      let vid = document.createElement('video');
      
      $(vid).attr('src', `/checkLabs/class/get_task_file?file_name=${name}&task_id=${task_id}&class_id=${class_id}`)
      $(vid).attr('controls', 'true')
      if($(vid).width()/$("#mdiv").width() > $(vid).height()/$("#mdiv").height()) {
        $(vid).css("width", "70%");
        $(vid).css("height", "auto");
      } else {
        $(vid).css("width", "auto");
        $(vid).css("height", "70%");
      }
      let imgObserver = new ResizeObserver(() => {
        if($(vid).width()/$("#mdiv").width() > $(vid).height()/$("#mdiv").height()) {
          $(vid).css("width", "70%");
          $(vid).css("height", "auto");
        } else {
          $(vid).css("width", "auto");
          $(vid).css("height", "70%");
        }
      });
      imgObserver.observe($("#mdiv")[0]);
      $("#mdiv").append(vid);
      for(let key in open_tabs) {
        if(key != name) { open_tabs[key][0].fadeOut(0); }
      }
      open_tabs[name] = [$(vid), NaN];
    } else if(name.endsWith('.mp3') || name.endsWith('.ogg') || name.endsWith('.wav')) {
      let audio = document.createElement('audio');
      init_audio();
      $(audio).attr('src', `/checkLabs/class/get_task_file?file_name=${name}&task_id=${task_id}&class_id=${class_id}`).attr('controls', true);
      let filters = qualize(audio);
      let div = document.createElement('div');
      $(div).css("display", "flex")
      $("#mdiv").append(div);
      div.append(audio);
      let div1 = document.createElement('div');
      $(div1).css('display', 'flex');
      let strf = JSON.parse(localStorage.filters);
      let filter = strf[name] || [0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
      strf[name] = filter;
      localStorage.filters = JSON.stringify(strf);
      for(let i = 0; i < 10; i++) {
        let item = document.createElement('input');
        item.type = 'range';
        item.min = -16;
        item.max = 16;
        item.value = filter[i];
        item.step = 0.1;
        item.setAttribute("orient", "vertical");
        div1.append(item);
        item.addEventListener('change', function (e) {
          filters[i].gain.value = e.target.value;
          filter[i] = e.target.value;
          let strf = JSON.parse(localStorage.filters);
          strf[name] = filter;
          localStorage.filters = JSON.stringify(strf);
        }, false);
      }
      div.append(div1);
      for(let key in open_tabs) {
        if(key != name) { open_tabs[key][0].fadeOut(0); }
      }
      open_tabs[name] = [$(div), NaN];
    } else {
      fetch(`/checkLabs/class/get_task_file/${class_id}/${task_id}/${name}`, {
        method: "GET",
        headers: {
          "ngrok-skip-browser-warning": Math.random(),
        }
      })
      .then(response => { return response.text() } )
      .then(data => {
        let area = CodeArea(document.querySelector("#mdiv"));
        area.area.setValue(data);
        area.area.clearHistory();
        area.cont.querySelector(".coAreaBlock-fname").textContent = name;
        $(area.cont.querySelector(".coAreaBlock-select")).change((e) => { area.area.setOption("mode", area.cont.querySelector(".coAreaBlock-select").value); })
        
        area.area.addKeyMap({ "Ctrl-S": (instance) => { 
          if(getCookie().autosaving == "true") {
            show_message("autosaving on");
          } else {
            save(name, area.area);
          }
        } });
        let pos = [0, 0];
        let changes = [];
        let change_timer = NaN;
        area.area.on('change', (cm, e) => {
          console.log(e);
          clearTimeout(change_timer);
            let ind1 = cm.getDoc().indexFromPos({line: e.from.line, ch: e.from.ch})
                changes.push(ind1.toString(16)+","+ (ind1+e.removed.join("\n").length).toString(16)+","+e.text.join('\n'));
          change_timer = setTimeout(() => {
            if(getCookie().autosaving == "true") {
              socket.emit('index files editnrfile', [name, changes]);
            }
          }, 3000);
        });
        
        $(area.cont).css({ 'width': '100%', 'height': '100%' });
        
        for(let key in open_tabs) {
          if(key != name) { open_tabs[key][0].fadeOut(0); }
        }
        open_tabs[name] = [$(area.cont), area.area];
      });
    }
    
    $(tabc).text('❌').click(function() {
      open_tabs[name][0].remove();
      $(tab).remove()
      delete open_tabs[name];
      let keys = Object.keys(open_tabs).filter((k, el) => k!='undefined');
      console.log(keys)
      if(name == nfile && keys.length >= 1) {
        gfile(task_name, keys.at(-1));
      }
    })
  }
}
 
    
    let params = new URLSearchParams(window.location.search);
    const class_id = {{ class_id }};
    
    function copy(text) {
      navigator.clipboard.writeText(text).then(function() {
        console.log('Text copied to clipboard');
      }).catch(function(error) {
        console.error('Error:', error);
      });
    }
    
    $("#mark-btn").click((e) => {
      $("#mark-modal").modal('hide');
    });
    
    var remove_stud = NaN;
    $("#remove-stud-modal-btn").click((e) => {
      $.ajax({
        url: '/checkLabs/class/remove-student',
        method: 'delete',
        headers: {
          "Content-Type": "application/json"
        },
        data: JSON.stringify({
          class_id: class_id,
          stud_id: remove_stud[0].id
        }),
        success: function(ans) {
          remove_stud[1].remove();
          $("#remove-stud-modal").modal('hide');
        }
      });
    })
    $("#remove-stud-modal").on('hidden.bs.modal', (e) => {
      remove_stud = NaN;
      $("#rem-name-stud").text('')
    })
    
    var cur_stud_file = NaN;
    function stud_task_file(task_id, name) {
      let el = document.createElement("div");
      el.classList.add('file');
      let ename = document.createElement("p");
      el.append(ename);
      let iname = document.createElement("a");
      ename.append(iname);
      let tname = document.createElement("a");
      tname.innerHTML = name.;
      ename.append(tname);
      $(iname).html(name.endsWith('.py') ? pythonIcon : name.endsWith('.html') ? htmlIcon : name.endsWith('.css') ? cssIcon : name.endsWith('.js') ? jsIcon : (name.endsWith('.png') || name.endsWith('.jpg') || name.endsWith('.svg') || name.endsWith('.gif')) ? imgIcon : name.endsWith('.json') ? jsonIcon : (name.endsWith('.mp3') || name.endsWith('.wav') || name.endsWith('.ogg') || name.endsWith('.m4a')) ? audioIcon : name.endsWith('.zip') ? zipIcon : (name.endsWith('.mp4') || name.endsWith('.avi')) ? videoIcon : name.endsWith('.txt') ? txtIcon : name.endsWith('.sh') ? bashIcon : otherIcon).css('margin-right', '4px');
      $(ename).click(function() {
        if(!tname.getAttribute('contenteditable')) {
          gfile(task_id, name);
        }
      });
      let epoint = document.createElement("a");
      epoint.textContent = '⋮';
      el.append(epoint);
      $(epoint).click(function(e) {
        cur_file = [el, task_id, name]
        $("#file-actions-cont").css('display', 'block').offset({ top: e.pageY+10, left: e.pageX+10 });
        preventDefaults(e);
      });
      return el;
    }
          
    var cur_stud_task = NaN;
    function stud_task_block(task) {
      let task_name = task.name;
      let task_el = document.createElement('div');
      task_el.style = "margin-left: 10px;";
      let task_nel = document.createElement('div');
      task_nel.opened = false;
      task_nel.classList.add('task');
      let ename = document.createElement("p");
      ename.innerHTML = task_name;
      task_nel.append(ename);
      let epoint = document.createElement("a");
      epoint.textContent = '⋮';
      task_nel.append(epoint);
      $(epoint).click(function(e) {  
        cur_stud_task = [task_el, task.id, task_name, task.stud_id]
        $("#task-actions-cont").css('display', 'block').offset({ top: e.pageY+10, left: e.pageX+10 });
        preventDefaults(e);
      });

      let task_cont = document.createElement('div');
      $(task_el).append(task_nel).append(task_cont);
      if(task_nel.opened) {
        $(task_cont).slideDown();
      } else {
        $(task_cont).slideUp();
      }
      $(ename).click((e) => {
        task_nel.opened = !task_nel.opened;
        if(task_nel.opened) {
          $(task_cont).slideDown();
        } else {
          $(task_cont).slideUp();
        }
      });
      for(let j = 0; j < task.files.length; j++) {
        let file_el = stud_task_file(task.id, task.files[j]);
        task_cont.append(file_el);
      }
      return task_el;
    }
    
    $("#act-task-mark-btn").click((e) => {
      $("#mark-modal").modal("show");
      $("#task-actions-cont").css('display', 'none');
      preventDefaults(e);
    });
    
    $("#act-task-neiro-btn").click((e) => {
      $("#mark-neiro-modal").modal("show");
      $("#task-actions-cont").css('display', 'none');
      $.ajax({
        url: '/checkLabs/class/neiroth',
        method: 'post',
        headers: {
          "Content-Type": "application/json"
        },
        data: JSON.stringify({
          class_id: class_id,
          stud_id: cur_stud_task[3],
          task_id: cur_stud_task[1],
        }),
        success: function(neiro_data) {
          neiro_data = JSON.parse(neiro_data);
          $("#mark-inp3").val(neiro_data[0]);
          $("#mark-description1").val(neiro_data[1]);
          $("#teach-verd").val(neiro_data[2]);
        }
      });
      preventDefaults(e);
    });
    
    function stud_block(stud, tasks) {
      let el = $(document.createElement("div"));
      let stud_el = $(document.createElement("div")).addClass('student');
      el.append(stud_el);
      let tname = $(document.createElement("a"));
      stud_el.append(tname);
      tname.text(`${stud.surname}${stud.name ? " "+stud.name : ""}${stud.otch ? " "+stud.otch : ""}`);
      let rsps = $(document.createElement("span"));
      stud_el.append(rsps);
      let edit = $(`<svg viewBox="0 0 64 64"><path d="M 48.097656 3.453125 C 47.0625 3.453125 46.027344 3.828125 45.269531 4.585938 L 41.03125 8.828125 C 40.25 8.046875 38.980469 8.046875 38.203125 8.828125 L 32.546875 14.484375 C 32.167969 14.863281 31.957031 15.367188 31.957031 15.902344 C 31.957031 16.433594 32.167969 16.9375 32.546875 17.3125 L 32.59375 17.363281 L 5.515625 44.398438 C 5.011719 44.902344 4.707031 45.570313 4.648438 46.28125 L 3.972656 54.675781 L 3.269531 59.597656 C 3.222656 59.910156 3.328125 60.222656 3.554688 60.449219 C 3.742188 60.636719 3.996094 60.738281 4.257813 60.738281 C 4.308594 60.738281 4.355469 60.738281 4.402344 60.730469 L 9.320313 60.03125 L 17.765625 59.40625 C 18.484375 59.355469 19.15625 59.046875 19.664063 58.539063 L 46.742188 31.5 C 47.113281 31.847656 47.589844 32.042969 48.101563 32.042969 C 48.636719 32.042969 49.136719 31.835938 49.515625 31.457031 L 55.171875 25.800781 C 55.953125 25.019531 55.953125 23.753906 55.171875 22.972656 L 59.417969 18.730469 C 60.171875 17.972656 60.585938 16.96875 60.585938 15.898438 C 60.585938 14.832031 60.171875 13.824219 59.414063 13.070313 L 50.929688 4.585938 C 50.175781 3.828125 49.136719 3.453125 48.097656 3.453125 Z M 48.097656 5.433594 C 48.617188 5.433594 49.136719 5.621094 49.515625 6 L 58 14.484375 C 58.378906 14.863281 58.585938 15.363281 58.585938 15.898438 C 58.585938 16.433594 58.378906 16.9375 58 17.3125 L 53.757813 21.558594 L 42.441406 10.242188 L 46.6875 6 C 47.0625 5.621094 47.582031 5.433594 48.097656 5.433594 Z M 39.613281 10.242188 L 40.324219 10.949219 L 53.050781 23.675781 L 53.757813 24.386719 L 52.34375 25.796875 C 51.953125 25.40625 51.320313 25.40625 50.929688 25.796875 L 49.515625 27.214844 C 49.125 27.605469 49.125 28.238281 49.515625 28.628906 L 48.101563 30.042969 L 33.957031 15.898438 L 35.371094 14.484375 C 35.566406 14.679688 35.820313 14.777344 36.078125 14.777344 C 36.335938 14.777344 36.589844 14.679688 36.785156 14.484375 L 38.203125 13.070313 C 38.59375 12.679688 38.59375 12.046875 38.203125 11.65625 Z M 41.03125 14.898438 C 40.773438 14.898438 40.519531 14.996094 40.324219 15.191406 L 38.90625 16.605469 C 38.515625 16.996094 38.515625 17.628906 38.90625 18.019531 C 39.101563 18.214844 39.359375 18.3125 39.613281 18.3125 C 39.871094 18.3125 40.128906 18.214844 40.324219 18.019531 L 41.734375 16.605469 C 42.128906 16.214844 42.128906 15.582031 41.734375 15.191406 C 41.539063 14.996094 41.285156 14.898438 41.03125 14.898438 Z M 44.5625 18.4375 C 44.308594 18.4375 44.054688 18.53125 43.859375 18.730469 L 42.441406 20.140625 C 42.050781 20.535156 42.050781 21.164063 42.441406 21.558594 C 42.636719 21.75 42.894531 21.847656 43.152344 21.847656 C 43.40625 21.847656 43.664063 21.75 43.859375 21.558594 L 45.269531 20.140625 C 45.664063 19.75 45.664063 19.121094 45.269531 18.730469 C 45.074219 18.53125 44.820313 18.4375 44.5625 18.4375 Z M 34.011719 18.777344 L 45.324219 30.09375 L 19.027344 56.347656 L 18.074219 51.582031 L 34.664063 34.992188 C 35.054688 34.601563 35.054688 33.96875 34.664063 33.578125 C 34.273438 33.1875 33.644531 33.1875 33.25 33.578125 L 16.65625 50.171875 L 14.300781 49.699219 L 13.828125 47.339844 L 27.59375 33.578125 C 27.988281 33.183594 27.988281 32.554688 27.59375 32.160156 C 27.203125 31.769531 26.574219 31.769531 26.183594 32.160156 L 12.417969 45.925781 L 7.753906 44.996094 Z M 48.101563 21.96875 C 47.84375 21.96875 47.589844 22.066406 47.394531 22.265625 L 45.980469 23.675781 C 45.589844 24.070313 45.589844 24.699219 45.980469 25.09375 C 46.175781 25.285156 46.429688 25.386719 46.6875 25.386719 C 46.945313 25.386719 47.199219 25.285156 47.394531 25.09375 L 48.808594 23.675781 C 49.199219 23.285156 49.199219 22.65625 48.808594 22.265625 C 48.613281 22.066406 48.359375 21.96875 48.101563 21.96875 Z M 32.546875 26.214844 C 32.289063 26.214844 32.035156 26.3125 31.839844 26.503906 L 29.011719 29.332031 C 28.617188 29.726563 28.617188 30.355469 29.011719 30.75 C 29.203125 30.941406 29.460938 31.042969 29.71875 31.042969 C 29.972656 31.042969 30.230469 30.941406 30.421875 30.75 L 33.25 27.921875 C 33.644531 27.527344 33.644531 26.898438 33.25 26.503906 C 33.054688 26.308594 32.800781 26.210938 32.546875 26.214844 Z M 6.609375 46.804688 L 11.894531 47.859375 L 12.46875 50.746094 C 12.550781 51.140625 12.859375 51.449219 13.253906 51.527344 L 16.136719 52.105469 L 17.203125 57.441406 L 9.59375 58 L 6 54.410156 Z"></path></svg>`);
      rsps.append(edit);
      let kick = $(document.createElement("img")).attr('src', '/static/kick.png');
      rsps.append(kick);
      kick.click((e) => {
        remove_stud = [stud, el];
        $("#rem-name-stud").text(`${stud.surname}${stud.name ? " "+stud.name : ""}${stud.otch ? " "+stud.otch : ""}`);
        $("#remove-stud-modal").modal('show');
      })
      let tasks_div = $(document.createElement("div"));
      $.ajax({
        url: '/checkLabs/class/get_studs_tasks_files',
        method: 'post',
        headers: {
          "Content-Type": "application/json"
        },
        data: JSON.stringify({
          class_id: class_id,
          stud_id: stud.id,
          task_id: tasks.map((el) => el.id)
        }),
        success: function(my_tasks_files_data) {
          if(my_tasks_files_data.ok) {
            for(let i = 0; i < tasks.length; i++) {
              if(my_tasks_files_data.tasks[tasks[i].id].started) {
                let task_cont = stud_task_block({
                  name: tasks[i].name,
                  files: tasks[i].files.concat(my_tasks_files_data.tasks[tasks[i].id].files.map((el) => "stud$"+stud.id+"$"+el)),
                  id: tasks[i].id,
                  stud_id: stud.id,
                });
                tasks_div.append(task_cont);
              }
            }
          }
        }
      });
      let opnd = false;
      if(opnd) {
        $(tasks_div).slideDown();
      } else {
        $(tasks_div).slideUp();
      }
      $(stud_el).click((e) => {
        opnd = !opnd;
        if(opnd) {
          $(tasks_div).slideDown();
        } else {
          $(tasks_div).slideUp();
        }
      });
      el.append(tasks_div);
      return el;
    }
        
    $.ajax({
      url: '/checkLabs/get-class',
      method: 'post',
      headers: {
        "Content-Type": "application/json"
      },
      data: JSON.stringify({
        id: class_id
      }),
      success: function(class_data) {
        if(class_data.ok) {
          let classd = class_data.class;
          let p_classid = $("#header-class-id").text("#"+classd.id)
          
          let students_root = $('#stud-list');
          if(classd.students.length) {
            $('#no-students').remove();
            for(let i = 0; i < classd.students.length; i++) {
              let s_a = stud_block(classd.students[i], classd.tasks);
              students_root.append(s_a);
            }
          }
          
          let mname = 'markl';
          nfile = mname;
          if(mname in open_tabs) {
            open_tabs[mname][0].fadeIn(0);
            for(let key in open_tabs) {
              if(key != mname) { open_tabs[key][0].fadeOut(0); }
            }
          } else {
            open_tabs[mname] = [];

            const tab = document.createElement("div");
            const tabt = document.createElement("p");
            $(tabt).text('Журнал').click(function() {
              gfile('', mname);
            })
            tab.append(tabt);
            const tabc = document.createElement("p");
            tab.append(tabc);
            tab.classList.add('tab');
            $("#tabs").append(tab);
            let table = $(document.createElement('table')).addClass('table table-striped table-bordered').css({'width': '100%', 'margin': '0', 'height': 'min-content'});
            $("#mdiv").append(table);
            let thead = $(document.createElement('thead'));
            table.append(thead);
            let tr = $(document.createElement('tr'));
            thead.append(tr);
            let th1 = $(document.createElement('th')).attr('scope', 'col').text('ФИО');
            let th2 = $(document.createElement('th')).attr('scope', 'col').text('Оценки');
            let th3 = $(document.createElement('th')).attr('scope', 'col').text('Ср. балл');
            tr.append(th1).append(th2).append(th3);
            let tbody = $(document.createElement('tbody'));
            table.append(tbody);
            for(let i = 0; i < classd.students.length; i++) {
              let tr = $(document.createElement('tr'));
              tbody.append(tr);
              let th1 = $(document.createElement('th')).text(`${classd.students[i].surname}${classd.students[i].name ? " "+classd.students[i].name : ""}${classd.students[i].otch ? " "+classd.students[i].otch : ""}`);
              let th2 = $(document.createElement('th')).text(classd.students[i].marks.join(' '));
              let th3 = $(document.createElement('th')).text(classd.students[i].marks.length ? parseFloat((classd.students[i].marks.reduce((partialSum, a) => partialSum + a, 0)/classd.students[i].marks.length).toFixed(3)) : "н/а");
              tr.append(th1).append(th2).append(th3);
            }
            let dt = table.DataTable({
              "scrollX": true,
              "info": false,
              "paging": false,
            }).columns.adjust();
            let Observer = new ResizeObserver(() => {
              dt.columns.adjust();
            });
            Observer.observe($("#mdiv")[0]);
            for(let key in open_tabs) {
              if(key != mname) { open_tabs[key][0].fadeOut(0); }
            }
            let prtable = table.parent().parent().parent().parent().parent()
            open_tabs[mname] = [prtable, table, dt];
          }
          
          function appl_block(appl) {
            let el = $(document.createElement("div")).addClass('student');
            let tname = $(document.createElement("a"));
            el.append(tname);
            tname.text(`${appl.surname}${appl.name ? " "+appl.name : ""}${appl.otch ? " "+appl.otch : ""}`);
            let rsps = $(document.createElement("span"));
            el.append(rsps);
            let accept = $(`<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" viewBox="0 0 517.062 517.062" style="enable-background:new 0 0 517.062 517.062;" xml:space="preserve"><circle style="fill: rgb(66, 186, 23);" cx="256" cy="258.531" r="256" fill="#3DB39E"/><path style="fill: rgb(27, 192, 55);" d="M499.43,179.284c-7.25-22.287-17.449-43.228-30.172-62.362l-224.087,233.4l0.451,25.974l10.578-0.067 L499.43,179.284L499.43,179.284z" fill="#37A18E"/><path style="" d="M512.389,103.303l-45.65-45.102c-6.231-6.159-16.338-6.159-22.569,0L249.032,259.202l-84.152-83.149 c-6.241-6.159-16.338-6.159-22.574,0l-40.463,39.982c-6.231,6.154-6.231,16.138,0,22.292l135.06,133.432 c3.599,3.558,8.479,4.992,13.169,4.439c4.69,0.548,9.569-0.881,13.169-4.439l249.149-246.159 C518.62,119.441,518.62,109.462,512.389,103.303L512.389,103.303z" fill="#F8F8F8"/><path style="" d="M263.24,371.76l249.149-246.159c6.231-6.159,6.231-16.138,0-22.298l-7.45-7.363L248.648,348.024 L107.5,210.439l-5.652,5.591c-6.231,6.154-6.231,16.138,0,22.292L236.902,371.76c3.599,3.558,8.479,4.992,13.169,4.439 C254.761,376.752,259.64,375.324,263.24,371.76L263.24,371.76z" fill="#EBEBEB"/></svg>`);
            rsps.append(accept);
            accept.click((e) => {
              $.ajax({
                url: '/checkLabs/class/accept-application',
                method: 'post',
                headers: {
                  "Content-Type": "application/json"
                },
                data: JSON.stringify({
                  id: appl.id
                }),
                success: function(acception) {
                  if(acception.ok) {
                    el.remove();
                    let student = {
                      id: appl.student,
                      name: appl.name,
                      surname: appl.surname,
                      otch: appl.otch
                    };
                    let s_a = stud_block(student, classd.tasks);
                    students_root.append(s_a);
                  } else {

                  }
                }
              });
            });
            let reject= $(`<svg version="1.1" viewBox="0 0 612 612" style="enable-background:new 0 0 612 612; color: red;" xml:space="preserve"><g><g id="_x31_0_23_"><g><path d="M306,0C136.992,0,0,136.992,0,306s136.992,306,306,306c168.988,0,306-137.012,306-306S475.008,0,306,0z M414.19,387.147c7.478,7.478,7.478,19.584,0,27.043c-7.479,7.478-19.584,7.478-27.043,0l-81.032-81.033l-81.588,81.588c-7.535,7.516-19.737,7.516-27.253,0c-7.535-7.535-7.535-19.737,0-27.254l81.587-81.587l-81.033-81.033c-7.478-7.478-7.478-19.584,0-27.042c7.478-7.478,19.584-7.478,27.042,0l81.033,81.033l82.181-82.18c7.535-7.535,19.736-7.535,27.253,0c7.535,7.535,7.535,19.737,0,27.253l-82.181,82.181L414.19,387.147z"/></g></g></g></svg>`);
            rsps.append(reject);
            reject.click((e) => {
              $.ajax({
                url: '/checkLabs/class/reject-application',
                method: 'post',
                headers: {
                  "Content-Type": "application/json"
                },
                data: JSON.stringify({
                  id: appl.id
                }),
                success: function(rejection) {
                  if(rejection.ok) {
                    el.remove();
                  } else {

                  }
                }
              });
            });
            return el;
          }
          
          let appl_root = $('#appl-list');
          $.ajax({
            url: '/checkLabs/class/get-applications',
            method: 'post',
            headers: {
              "Content-Type": "application/json"
            },
            data: JSON.stringify({
              class_id: class_id
            }),
            success: function(appl_data) {
              if(appl_data.ok) {
                if(appl_data.applications.length) {
                  $('#no-applications').remove();
                  for(let i = 0; i < appl_data.applications.length; i++) {
                    let appl_el = appl_block(appl_data.applications[i]);
                    appl_root.append(appl_el);
                  }
                }
              } else {

              }
            }
          });
          
          var cur_file = NaN;
          function task_file(task_id, name) {
            let el = document.createElement("div");
            el.classList.add('file');
            let ename = document.createElement("p");
            el.append(ename);
            let iname = document.createElement("a");
            ename.append(iname);
            let tname = document.createElement("a");
            tname.innerHTML = name;
            ename.append(tname);
            $(iname).html(name.endsWith('.py') ? pythonIcon : name.endsWith('.html') ? htmlIcon : name.endsWith('.css') ? cssIcon : name.endsWith('.js') ? jsIcon : (name.endsWith('.png') || name.endsWith('.jpg') || name.endsWith('.svg') || name.endsWith('.gif')) ? imgIcon : name.endsWith('.json') ? jsonIcon : (name.endsWith('.mp3') || name.endsWith('.wav') || name.endsWith('.ogg') || name.endsWith('.m4a')) ? audioIcon : name.endsWith('.zip') ? zipIcon : (name.endsWith('.mp4') || name.endsWith('.avi')) ? videoIcon : name.endsWith('.txt') ? txtIcon : name.endsWith('.sh') ? bashIcon : otherIcon).css('margin-right', '4px');
            $(ename).click(function() {
              if(!tname.getAttribute('contenteditable')) {
                gfile(task_id, name);
              }
            });
            let epoint = document.createElement("a");
            epoint.textContent = '⋮';
            el.append(epoint);
            $(epoint).click(function(e) {
              cur_file = [el, task_id, name]
              $("#file-actions-cont").css('display', 'block').offset({ top: e.pageY+10, left: e.pageX+10 });
              preventDefaults(e);
            });
            return el;
          }
          
          var cur_task = NaN;
          function task_block(task) {
            let task_name = task.name;
            let task_el = document.createElement('div');
            
            let task_nel = document.createElement('div');
            task_nel.opened = false;
            task_nel.classList.add('task');
            let ename = document.createElement("p");
            ename.innerHTML = task_name;
            task_nel.append(ename);
            let epoint = document.createElement("a");
            epoint.textContent = '⋮';
            task_nel.append(epoint);
            $(epoint).click(function(e) {          
              $("#task-modal").modal("show");
              cur_task = [task_el, task];
              $("#name-task-edit").val(task_name);
              $("#time-task-edit").val(task.acct);
              if(task.access) {
                $("#task-form-edit").css("grid-template-areas", '"b c" "e e" "a a"');
                $("#time-task-edit").css("display", "none");
                $("#edit-access").text(`Закрыть доступ${task.acct ? "(до закрытия: "+task.acct+" минут)" : ""}`);
              } else {
                $("#task-form-edit").css("grid-template-areas", '"b c" "d e" "a a"');
                $("#time-task-edit").css("display", "block");
                $("#edit-access").text("Открыть доступ");
              }
              preventDefaults(e);
            });
            
            let task_cont = document.createElement('div');
            $(task_el).append(task_nel).append(task_cont);
            if(task_nel.opened) {
              $(task_cont).slideDown();
            } else {
              $(task_cont).slideUp();
            }
            $(task_nel).click((e) => {
              task_nel.opened = !task_nel.opened;
              if(task_nel.opened) {
                $(task_cont).slideDown();
              } else {
                $(task_cont).slideUp();
              }
            });
            for(let j = 0; j < task.files.length; j++) {
              let file_el = task_file(task.id, task.files[j]);
              task_cont.append(file_el);
            }
            $(task_el).dropzone({ 
              url: `/checkLabs/class/upload_task`,
              paramName: 'file',
              chunking: true,
              forceChunking: true,
              maxFilesize: 1024, // megabytes 
              chunkSize: 1024*1024*2, // bytes
              addedfile: function(file) {
                file.previewElement = document.createElement('div');
                task_cont.append(file.previewElement)
              },
              uploadprogress: function(file, progress, bytesSent) {
                file.previewElement.textContent = progress+"%";
              },
              complete: function(file) {
                file.previewElement.remove();
                file.previewElement = task_file(task_name, file.name);
                task_cont.append(file.previewElement);
              },
              sending: function(file, xhr, formData) {
                formData.append("name", file.name);
                formData.append("class_id", class_id);
                formData.append("task_id", task.id);
              }
            });
            return task_el
          }
          
          if(classd.tasks.length) {
            $('#no-tasks').remove();
            for(let i = 0; i < classd.tasks.length; i++) {
              $("#task-list").append(task_block(classd.tasks[i]));
            }
          }
          
          $("#add-task-btn").click((e) => {
            let name = $("#new-task-name").val();
            if(!name) { return }
            $.ajax({
              url: '/checkLabs/class/add_task',
              method: 'post',
              headers: {
                "Content-Type": "application/json"
              },
              data: JSON.stringify({
                class_id: class_id,
                name: name,
              }),
              success: function(ans) {
                if(ans.ok) {
                  $("#add-task-modal").modal('hide');
                  $("#new-task-name").val('');
                  $("#task-list").append(task_block(ans.task));
                }
              }
            });
          });
          
          $("#delete-task-btn").click((e) => {
            $.ajax({
              url: '/checkLabs/class/delete_task',
              method: 'delete',
              headers: {
                "Content-Type": "application/json"
              },
              data: JSON.stringify({
                class_id: class_id,
                task_id: cur_task[1].id
              }),
              success: function(ans) {
                if(ans.ok) {   
                  $("#task-modal").modal("hide");
                  cur_task[0].remove();
                  cur_task = NaN;
                }
              }
            });
          });
          
          $("#edit-access").click((e) => {
            $.ajax({
              url: '/checkLabs/class/access-task',
              method: 'put',
              headers: {
                "Content-Type": "application/json"
              },
              data: JSON.stringify({
                class_id: class_id,
                task_id: cur_task[1].id,
                access: (cur_task[1].access ? 0 : 1),
                acct: $("#time-task-edit").val() || 0
              }),
              success: function(ans) {
                if(ans.ok) {  
                  cur_task[1].access = (cur_task[1].access ? 0 : 1);
                  cur_task[1].acct = $("#time-task-edit").val() || 0;
                  $("#task-modal").modal("hide");
                  cur_task = NaN;
                }
              }
            });
          });
          
          $("#delete-file-btn").click((e) => {
            $.ajax({
              url: '/checkLabs/class/delete_file',
              method: 'delete',
              headers: {
                "Content-Type": "application/json"
              },
              data: JSON.stringify({
                class_id: class_id,
                task_name: cur_file[1],
                name: cur_file[2]
              }),
              success: function(ans) {
                if(ans.ok) {
                  cur_file[0].remove()
                  cur_file = NaN;
                }
              }
            });
          });
          
          $('.toolh').each((ind, el) => {
            let root = $(el);
            let elm = $(root.attr('target'));
            if(root.attr('opened') == "0") {
              $(elm.attr('target')).slideUp();
            } else {
              $(elm.attr('target')).slideDown();
            }
            elm.click(function(e) {
              if(root.attr('opened') == "0") {
                root.attr("opened", "1");
                $(elm.attr('target')).slideDown();
              } else {
                root.attr("opened", "0");
                $(elm.attr('target')).slideUp();
              }
            })
          })
          
          $("#add-stud-modal").on('hidden.bs.modal', (e) => {
            $('#inv-token').text('');
            $("#new-name").val('');
            $("#new-surname").val('');
            $("#new-otch").val('');
          })
        }
      }
    });
    
    $("#file-actions-cont").css('display', 'none');
    $("#task-actions-cont").css('display', 'none');
    $('body').on('mouseup', function() {
      $("#file-actions-cont").css('display', 'none');
      $("#task-actions-cont").css('display', 'none');
//       if(renfile) { $(renfile).removeAttr("contenteditable").off('keydown').text(contextPath.split('/').at(-1)); }
    })
  </script>
</html>
